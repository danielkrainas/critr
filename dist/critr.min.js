/*! critr v1.0.0 (https://github.com/danielkrainas/critr) */
(function(){var a={},b=function(b,c){a[b]={exporter:c,ready:!1}},c=function(b){var d=a[b];return d&&!d.ready&&(d.exports={},d.exporter.call(null,c,d,d.exports),d.ready=!0),d&&d.exports};b("./utils",function(a,b,c){"use strict";var d=function(a,b){return a.key>b.key};c.isEmptyObject=function(a){return"{}"===JSON.stringify(a)},c.bind=function(a,b){return function(){var c=Array.prototype.slice.call(arguments,0);return a.apply(b,c)}};var e=c.map=function(a,b,c){for(var d=[],e=0;e<a.length;e++)d.push(b.call(c,a[e],e));return d},f=c.getProperties=function(a){return"object"==typeof a&&a?e(Object.keys(a),function(b){return{key:b,value:a[b]}}):[]},g=c.deepClone=function(a){if(null===a)return null;var b={};return f(a).forEach(function(a){a.value&&"object"==typeof a.value&&(a.value=g(a.value)),b[a.key]=a.value}),b};c.resolve=function(a,b){for(var c=b.split("."),d=0;d<c.length;d++){if("undefined"==typeof a[c[d]])return null;a=a[c[d]]}return a};var h=c.deepCompare=function(a,b){if(null===a||"object"!=typeof a)return a===b;var c=f(a),e=f(b);if(c.length!==e.length)return!1;c.sort(d),e.sort(d);for(var g=0;g<c.length;g++)if(c[g].key!==e[g].key||!h(c[g].value,e[g].value))return!1;return!0};c.asArray=function(a){return Array.isArray(a)?a:[a]},c.defer=function(a,b){return setTimeout(function(){a.apply(null,b||[])},0)}}),b("./accumulators",function(a,b,c){"use strict";var d=a("./utils"),e=function(a,b,c){return a.reduce(d.bind(c,this),b)},f=function(a,b){return 1===arguments.length&&(b=a,a=null),function(c,d){return e.call(this,c,a,function(a,c){return b.call(this,d,c,this.evaluate(c,d),a)})}},g=c.$sum=f(0,function(a,b,c,d){return"number"==typeof a?d+a:d+c});c.$avg=function(a,b){var c=g.call(this,a,b);return c/a.length},c.$first=function(a,b){return this.evaluate(a[0],b)},c.$last=function(a,b){return this.evaluate(a[a.length-1],b)},c.$max=f(function(a,b,c,d){return null===d?c:Math.max(d,c)}),c.$min=f(function(a,b,c,d){return null===d?c:Math.min(d,c)}),c.$push=function(a,b){return a.map(d.bind(function(a){return this.evaluate(a,b)},this))},c.$addToSet=function(a,b){var c=[];return a.forEach(d.bind(function(a){var d=this.evaluate(a,b);c.indexOf(d)<0&&c.push(d)},this)),c}}),b("./operators",function(a,b,c){"use strict";var d=a("./utils"),e=function(){return!0},f=function(a,b){return 1===arguments.length&&(b=a,a=null),function(c){return c.param.reduce(d.bind(function(a,d){return b.call(this,c,d,a)},this),a)}};c.$and=f(!0,function(a,b,c){return c&&this.test(a.data,b)}),c.$or=f(!1,function(a,b,c){return c||this.test(a.data,b)}),c.$nor=function(a){return a.param.reduce(d.bind(function(b,c){return b&&!this.test(a.data,c)},this),!0)},c.$not=function(a){return!this.test(a.data,a.param)},c.$eq=function(a){return d.deepCompare(a.data,a.param)},c.$ne=function(a){return!d.deepCompare(a.data,a.param)},c.$lt=function(a){return a.data<a.param},c.$lte=function(a){return a.data<=a.param},c.$gt=function(a){return a.data>a.param},c.$gte=function(a){return a.data>=a.param},c.$in=function(a){var b=d.asArray(a.data);return d.asArray(a.param).some(function(a){return b.indexOf(a)>=0})},c.$nin=function(a){var b=d.asArray(a.data);return d.asArray(a.param).every(function(a){return b.indexOf(a)<0})},c.$exists=function(a){return!(a.param^null!==a.data)},c.$type=function(a){return typeof a.data===a.param},c.$regex=function(a){var b=a.param;return b instanceof RegExp||(b=new RegExp(b,a.expression.$options)),a.data?null!==a.data.match(b):!1},c.$options=e,c.$where=function(a){return a.param.call(null,a.data)},c.$all=function(a){var b=d.asArray(a.data);return a.param.every(function(a){return b.indexOf(a)>=0})},c.$elemMatch=function(a){return Array.isArray(a.data)&&a.data.some(function(b){return this.test(b,a.param)},this)},c.$size=function(a){return a.param===(Array.isArray(a.data)?a.data.length:0)},c.$literal=function(a){return a.param},c.$toLower=function(a){return(this.evaluate(a.data,a.param)||"").toLowerCase()},c.$toUpper=function(a){return(this.evaluate(a.data,a.param)||"").toUpperCase()},c.$ifNull=function(a){var b=this.evaluate(a.data,a.param[0]);return null!==b?b:this.evaluate(a.data,a.param[1])},c.$cond=function(a){var b=this.test(a.data,a.param["if"]);return b?this.evaluate(a.data,a.param.then):this.evaluate(a.data,a.param["else"])},c.$add=f(0,function(a,b,c){return c+this.evaluate(a.data,b)}),c.$subtract=f(function(a,b,c){var d=this.evaluate(a.data,b);return null===c?d:c-d}),c.$multiply=f(1,function(a,b,c){return c*this.evaluate(a.data,b)}),c.$divide=f(function(a,b,c){var d=this.evaluate(a.data,b);return null===c?d:c/d}),c.$mod=function(a){return this.evaluate(a.data,a.param[0])%this.evaluate(a.data,a.param[1])}}),b("./stages",function(a,b,c){"use strict";var d=a("./utils"),e=function(a,b){return function(c,d){(!b||b.call(this,c))&&c.forEachItem(function(b,d){a.call(this,c,b,d)}),d()}};c.$group=function(a,b){a.outputAll(this.group(a.data,a.param)),b()},c.$sort=function(a,b){var c=a.data.sort(function(b,c){for(var d=0;d<a.paramKeys.length;d++){var e=a.paramKeys[d],f=b[e],g=c[e],h=0;if(g>f?h=-1:f>g&&(h=1),h*=a.param[e],0!==h)return h}return 0});a.outputAll(c),b()},c.$output=e(function(a,b){a.param.push(b),a.output(b)},function(a){return a.param&&a.param.push}),c.$limit=e(function(a,b,c){c<a.param&&a.output(b)}),c.$skip=e(function(a,b,c){c>=a.param&&a.output(b)}),c.$match=e(function(a,b){this.test(b,a.param)&&a.output(b)}),c.$project=e(function(a,b){var c={};a.forEachParamKey(function(a,d){var e=!1,f=b[a];d===!0||1===d?e=!0:d===!1||0===d?e=!1:(f=this.evaluate(b,d),e=!0),e&&(c[a]=f)}),a.output(c)}),c.$unwind=e(function(a,b){var c=a.param.slice(1),e=this.evaluate(b,a.param);if(null!==e&&Array.isArray(e))for(var f=0;f<e.length;f++){var g=d.deepClone(b);g[c]=e[f],a.output(g)}})}),b("./stage-context",function(a,b){"use strict";var c=function(a,b,c){var d=Object.keys(a)[0];this.results=[],this.data=b,this.count=b.length,this.stage=a,this.operator=c.stage(d),this.name=d,this.param=a[d],this.critr=c,this.paramKeys="object"==typeof this.param?Object.keys(this.param):[]};c.prototype.forEachItem=function(a){var b=this.critr;this.data.forEach(function(c,d){a.call(b,c,d)})},c.prototype.outputAll=function(a){a=a||[],this.results=this.results.concat(a)},c.prototype.output=function(a){null!==a&&this.results.push(a)},c.prototype.callOperator=function(a){var b=this;this.operator.call(this.critr,this,function(){a(b.results)})},c.prototype.forEachParamKey=function(a){var b=this.critr,c=this.param;this.paramKeys.forEach(function(d){a.call(b,d,c[d])})};var d=function(a){this.critr=a};d.prototype.create=function(a){return new c(a.stage,a.data,this.critr)},b.exports=d}),b("./grouper",function(a,b){"use strict";var c=function(a){this._idExpression=a,this.lookup={},this.ids=[]};c.prototype.makeFilter=function(){var a=this;return function(b){var c=this.evaluate(b,a._idExpression);a.ids.indexOf(c)<0?(a.ids.push(c),a.lookup[c]=[b]):a.lookup[c].push(b)}},c.prototype.map=function(a,b){for(var c=[],d=0;d<this.ids.length;d++)c.push(a.call(b,this.ids[d],this.lookup[this.ids[d]]));return c},b.exports=c}),function(a){"use strict";var b=c("./utils"),d=c("./grouper"),e=c("./stage-context"),f=function(a){return function(b,c,d){var e=this[a];if(1===arguments.length)return e[b];if(b in e){if(!d)return!1;e[b]=c}else e[b]=c;return!0}},Critr=function(a){a=a||{},this.stages={},this.operators={},this.accumulators={},a.defaults&&(this.operators=Object.create(Critr.defaults.operators)),a.defaultStages&&(this.stages=Object.create(Critr.defaults.stages)),a.defaultAccumulators&&(this.accumulators=Object.create(Critr.defaults.accumulators))};Critr.defaults={accumulators:c("./accumulators"),stages:c("./stages"),operators:c("./operators")},Critr.prototype.Critr=Critr,Critr.prototype.stage=f("stages"),Critr.prototype.accumulator=f("accumulators"),Critr.prototype.operator=f("operators"),Critr.prototype.test=function(a,c){for(var d=!1,e=b.getProperties(c);e.length>0;){var f=e.shift(),g=a?b.resolve(a,f.key):null;if("$"!==f.key[0])"object"!=typeof f.value?d=f.value===g:f.value&&(d=this.test(g,f.value));else{var h=this.operator(f.key);if(!h)throw new Error(f.key+" operator is not supported.");d=!!h.call(this,{param:f.value,data:a,expression:c})}if(!d)break}return d},Critr.prototype.evaluate=function(a,c){var d=null;if("string"==typeof c&&"$"===c[0])d=b.resolve(a,c.slice(1));else if("number"==typeof c)d=c;else for(var e=b.getProperties(c),f=0;f<e.length;f++){var g=e[f],h=this.operator(g.key);if(!h)throw new Error(g.key+" operator is not supported.");d=h.call(this,{param:g.value,data:a,expression:c})}return d},Critr.prototype.pipe=function(a,c,d){a=(a||[]).slice(0);var f=-1,g=new e(this),h=function(){if(++f>=c.length)return d(a);var e=c[f],i=g.create({stage:e,data:a});return i.operator?void i.callOperator(function(c){a=c,b.defer(h)}):d(null,new Error(i.name+" is not a known stage operator."))};b.defer(h)},Critr.prototype.group=function(a,c){var e=new d(c._id||"");a.forEach(e.makeFilter(),this);var f=b.map(b.getProperties(c).filter(function(a){return!e._idExpression||a.value!==e._idExpression}),function(a){var b=null;return b=Object.keys(a.value)[0],{accumulatorKey:b,accumulator:this.accumulator(b),accumulatorExpression:a.value[b],expressionProperty:a}},this);return e.map(function(a,b){var c={};return null!==e._idExpression&&(c._id=a),f.forEach(function(a){if(!a.accumulator)throw new Error(a.accumulatorKey+" accumulator is not supported.");c[a.expressionProperty.key]=a.accumulator.call(this,b,a.accumulatorExpression)},this),c},this)},Critr.prototype.count=function(a,c){return c?(a=b.asArray(a),b.isEmptyObject(c)?a.length:a.reduce(b.bind(function(a,b){return this.test(b,c)?a+1:a},this),0)):0},a.exports=new Critr({defaults:!0,defaultStages:!0,defaultAccumulators:!0})}(function(a){return Object.defineProperty({},"exports",{set:function(b){a.critr=b},get:function(){return a.critr}})}(this))}).call(this);